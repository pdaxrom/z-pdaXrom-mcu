;
; HJ12864-COG-5
;
; GPIO 3 - PIN_RS
; GPIO 4 - PIN_RSTB
; MSS    - PIN_CSB
; MOSI   - PIN_SDA
; MSCK   - PIN_SCLK
;

PIN_RS		equ	$08
PIN_RSTB	equ	$10

	include ../DEVMAP.INC

	include ../BOOTMEM.INC

	include ../BOOTROM.INC

	org $100

	sei

	lds	#$fff

	ldx	#hello
;	int	F_PUTSTR
	jsr	F_UART_PUTS

	bsr	disp_init

	ldx	#giftbox
	jsr	lcd_show

	jmp	F_RESET

send_byte proc
;	jsr	printhex
busy	ldab	SPI_STATUS
	bitb	#SPI_READY
	beq	busy
	staa	SPI_DATA+1
	rts
	endp

send_cmd proc
;	jsr	printhex
	pshb
	ldab	GPIO_DATA+3
	andb	#$FF^PIN_RS
	stab	GPIO_DATA+3
	bsr	send_byte
	pulb
	rts
	endp

send_data proc
;	jsr	printhex
	pshb
	ldab	GPIO_DATA+3
	orab	#PIN_RS
	stab	GPIO_DATA+3
	bsr	send_byte
	pulb
	rts
	endp

delay	proc
	pshb
	psha
loop	ldab	#110
loop1	decb
	bne	loop1
	deca
	bne	loop
	pula
	pulb
	rts
	endp

disp_init proc
	ldaa	#(PIN_RS | PIN_RSTB)
	staa	GPIO_DIR+3

	ldaa	#2
	staa	SPI_PRESCALER
	ldaa	#SPI_SSM
	staa	SPI_CONFIG

	ldaa	GPIO_DATA+3
	anda	#$FF^PIN_RSTB
	staa	GPIO_DATA+3

	ldaa	#20
	bsr	delay

	ldab	GPIO_DATA+3
	orab	#PIN_RSTB
	stab	GPIO_DATA+3

	ldaa	#0
	staa	SPI_CONFIG

	ldaa	#20
	bsr	delay

	ldx	#init1
loop1	ldaa	0,x
	bsr	send_cmd

	ldaa	#50
	bsr	delay

	inx
	cpx	#init1+4
	bne	loop1

	ldx	#init2
loop2	ldaa	0,x
	bsr	send_cmd

	inx
	cpx	#init2+8
	bne	loop2

	rts
init1	db	$e2, $2c, $2e, $2f
init2	db	$24, $81, $1f, $a2, $c8, $a0, $60, $af
	endp

lcd_address proc
	psha
	pshb
	deca
	adda	#$B0
	jsr	send_cmd
	tba
	lsra
	lsra
	lsra
	lsra
	adda	#$10
	jsr	send_cmd
	tba
	anda	#$0F
	jsr	send_cmd
	pulb
	pula
	rts
	endp

lcd_show proc
	pshy
	pshb
	ldy	#ROT8x8_IO
	ldaa	#0
loop	psha
busy1	ldab	SPI_STATUS
	bitb	#SPI_READY
	beq	busy1
	adda	#$B0
	jsr	send_cmd
	ldaa	#$10
	jsr	send_cmd
	ldaa	#$01
	jsr	send_cmd

busy2	ldab	SPI_STATUS
	bitb	#SPI_READY
	beq	busy2

	ldaa	#16
loop1	psha
	ldaa	$00,x
	staa	0,y
	ldaa	$10,x
	staa	1,y
	ldaa	$20,x
	staa	2,y
	ldaa	$30,x
	staa	3,y
	ldaa	$40,x
	staa	4,y
	ldaa	$50,x
	staa	5,y
	ldaa	$60,x
	staa	6,y
	ldaa	$70,x
	staa	7,y
	ldaa	0,y
	jsr	send_data
	ldaa	1,y
	jsr	send_data
	ldaa	2,y
	jsr	send_data
	ldaa	3,y
	jsr	send_data
	ldaa	4,y
	jsr	send_data
	ldaa	5,y
	jsr	send_data
	ldaa	6,y
	jsr	send_data
	ldaa	7,y
	jsr	send_data
	inx
	pula
	deca
	bne	loop1

	ldab	#128-16
	abx

;	jsr	F_UART_IN

	pula
	inca
	cmpa	#8
	beq	exit
	jmp	loop
exit	pulb
	puly
	rts
	endp

printhex proc
	pshx
	psha
	pshb
	jsr	F_UART_PUTHEX
	tba
	jsr	F_UART_PUTHEX
	ldx	#crlf
	jsr	F_UART_PUTS
	pulb
	pula
	pulx
	rts
crlf	db	10, 13, 0
	endp

hello	db	'COGSPI test', 10, 13, 0

ledhex	db	$3f, $06, $5B, $4F, $66, $6D, $7D, $07, $7F, $6F, $77, $7C, $39, $5E, $79, $71

heart
    db $00, $00, $00, $00, $00, $00, $00, $00, $00, $00, $00, $00, $00, $00, $00, $00
    db $00, $00, $00, $00, $00, $00, $00, $00, $00, $00, $00, $00, $00, $00, $00, $00
    db $00, $00, $00, $00, $00, $00, $00, $00, $00, $00, $00, $00, $00, $00, $00, $00
    db $00, $00, $00, $0F, $FF, $F0, $00, $00, $00, $00, $1F, $FF, $D0, $00, $00, $00
    db $00, $00, $01, $FD, $49, $7F, $80, $00, $00, $03, $FA, $95, $FF, $00, $00, $00
    db $00, $00, $0F, $A0, $00, $02, $F8, $00, $00, $1F, $00, $00, $03, $F0, $00, $00
    db $00, $00, $3C, $00, $00, $00, $3F, $00, $00, $F8, $00, $00, $00, $7E, $00, $00
    db $00, $01, $F0, $00, $00, $00, $03, $C0, $03, $C0, $00, $00, $00, $07, $80, $00
    db $00, $03, $80, $00, $00, $00, $00, $F0, $0F, $00, $00, $00, $00, $01, $C0, $00
    db $00, $0E, $00, $00, $00, $00, $00, $38, $1C, $00, $00, $00, $00, $00, $70, $00
    db $00, $1C, $00, $00, $00, $00, $00, $0E, $78, $00, $00, $00, $00, $00, $3C, $00
    db $00, $78, $00, $00, $00, $00, $00, $07, $E0, $00, $00, $00, $00, $00, $1C, $00
    db $00, $60, $00, $00, $00, $00, $00, $03, $C0, $00, $00, $00, $00, $00, $07, $00
    db $00, $E0, $00, $00, $00, $00, $00, $01, $00, $00, $00, $00, $00, $00, $07, $00
    db $01, $C0, $00, $00, $00, $00, $00, $00, $00, $00, $00, $00, $00, $00, $03, $80
    db $03, $80, $00, $00, $00, $00, $00, $00, $00, $00, $00, $00, $00, $00, $01, $80
    db $03, $80, $00, $00, $00, $00, $00, $00, $00, $00, $00, $00, $00, $00, $01, $C0
    db $03, $00, $00, $00, $00, $00, $00, $00, $00, $00, $00, $00, $00, $00, $00, $C0
    db $07, $00, $00, $00, $00, $00, $00, $00, $00, $00, $00, $00, $00, $00, $00, $E0
    db $07, $00, $00, $00, $00, $00, $00, $00, $00, $00, $00, $00, $00, $00, $00, $E0
    db $07, $00, $00, $00, $00, $00, $00, $00, $00, $00, $00, $00, $00, $00, $00, $E0
    db $03, $00, $00, $00, $00, $00, $00, $00, $00, $00, $00, $00, $00, $00, $00, $C0
    db $07, $00, $00, $00, $00, $00, $00, $00, $00, $00, $00, $00, $00, $00, $00, $E0
    db $03, $00, $00, $00, $00, $00, $00, $00, $00, $00, $00, $00, $00, $00, $00, $C0
    db $03, $80, $00, $00, $00, $00, $00, $00, $00, $00, $00, $00, $00, $00, $01, $C0
    db $01, $80, $00, $00, $00, $00, $00, $00, $00, $00, $00, $00, $00, $00, $01, $C0
    db $01, $C0, $00, $00, $00, $00, $00, $00, $00, $00, $00, $00, $00, $00, $03, $80
    db $00, $E0, $00, $00, $00, $00, $00, $00, $00, $00, $00, $00, $00, $00, $03, $00
    db $00, $E0, $00, $00, $00, $00, $00, $00, $00, $00, $00, $00, $00, $00, $07, $00
    db $00, $70, $00, $00, $00, $00, $00, $00, $00, $00, $00, $00, $00, $00, $0E, $00
    db $00, $38, $00, $00, $00, $00, $00, $00, $00, $00, $00, $00, $00, $00, $1C, $00
    db $00, $1C, $00, $00, $00, $00, $00, $00, $00, $00, $00, $00, $00, $00, $38, $00
    db $00, $0F, $00, $00, $00, $00, $00, $00, $00, $00, $00, $00, $00, $00, $70, $00
    db $00, $03, $80, $00, $00, $00, $00, $00, $00, $00, $00, $00, $00, $01, $E0, $00
    db $00, $01, $C0, $00, $00, $00, $00, $00, $00, $00, $00, $00, $00, $03, $80, $00
    db $00, $00, $F0, $00, $00, $00, $00, $00, $00, $00, $00, $00, $00, $0F, $00, $00
    db $00, $00, $3C, $00, $00, $00, $00, $00, $00, $00, $00, $00, $00, $3C, $00, $00
    db $00, $00, $0F, $00, $00, $00, $00, $00, $00, $00, $00, $00, $00, $F0, $00, $00
    db $00, $00, $03, $80, $00, $00, $00, $00, $00, $00, $00, $00, $01, $C0, $00, $00
    db $00, $00, $00, $F0, $00, $00, $00, $00, $00, $00, $00, $00, $07, $80, $00, $00
    db $00, $00, $00, $78, $00, $00, $00, $00, $00, $00, $00, $00, $1E, $00, $00, $00
    db $00, $00, $00, $0F, $00, $00, $00, $00, $00, $00, $00, $00, $78, $00, $00, $00
    db $00, $00, $00, $07, $C0, $00, $00, $00, $00, $00, $00, $01, $E0, $00, $00, $00
    db $00, $00, $00, $00, $F0, $00, $00, $00, $00, $00, $00, $07, $80, $00, $00, $00
    db $00, $00, $00, $00, $3C, $00, $00, $00, $00, $00, $00, $1E, $00, $00, $00, $00
    db $00, $00, $00, $00, $0F, $00, $00, $00, $00, $00, $00, $F8, $00, $00, $00, $00
    db $00, $00, $00, $00, $03, $C0, $00, $00, $00, $00, $03, $C0, $00, $00, $00, $00
    db $00, $00, $00, $00, $00, $F0, $00, $00, $00, $00, $0F, $00, $00, $00, $00, $00
    db $00, $00, $00, $00, $00, $3C, $00, $00, $00, $00, $3C, $00, $00, $00, $00, $00
    db $00, $00, $00, $00, $00, $0F, $00, $00, $00, $00, $F0, $00, $00, $00, $00, $00
    db $00, $00, $00, $00, $00, $03, $C0, $00, $00, $03, $C0, $00, $00, $00, $00, $00
    db $00, $00, $00, $00, $00, $00, $F0, $00, $00, $0F, $00, $00, $00, $00, $00, $00
    db $00, $00, $00, $00, $00, $00, $3C, $00, $00, $3C, $00, $00, $00, $00, $00, $00
    db $00, $00, $00, $00, $00, $00, $0E, $00, $00, $70, $00, $00, $00, $00, $00, $00
    db $00, $00, $00, $00, $00, $00, $03, $80, $01, $C0, $00, $00, $00, $00, $00, $00
    db $00, $00, $00, $00, $00, $00, $01, $E0, $07, $80, $00, $00, $00, $00, $00, $00
    db $00, $00, $00, $00, $00, $00, $00, $70, $0E, $00, $00, $00, $00, $00, $00, $00
    db $00, $00, $00, $00, $00, $00, $00, $3C, $3C, $00, $00, $00, $00, $00, $00, $00
    db $00, $00, $00, $00, $00, $00, $00, $0E, $70, $00, $00, $00, $00, $00, $00, $00
    db $00, $00, $00, $00, $00, $00, $00, $07, $E0, $00, $00, $00, $00, $00, $00, $00
    db $00, $00, $00, $00, $00, $00, $00, $03, $80, $00, $00, $00, $00, $00, $00, $00
    db $00, $00, $00, $00, $00, $00, $00, $00, $00, $00, $00, $00, $00, $00, $00, $00
    db $00, $00, $00, $00, $00, $00, $00, $00, $00, $00, $00, $00, $00, $00, $00, $00
    db $00, $00, $00, $00, $00, $00, $00, $00, $00, $00, $00, $00, $00, $00, $00, $00

giftbox
    db $00, $00, $00, $00, $00, $00, $00, $00, $00, $10, $00, $00, $00, $00, $00, $00
    db $00, $00, $00, $00, $00, $00, $00, $FF, $FF, $FC, $00, $00, $00, $00, $00, $00
    db $00, $00, $00, $00, $00, $00, $01, $80, $07, $06, $00, $00, $00, $00, $00, $00
    db $00, $00, $00, $00, $00, $00, $01, $80, $06, $07, $F0, $00, $00, $00, $00, $00
    db $00, $00, $00, $00, $00, $01, $F9, $87, $84, $38, $09, $FF, $00, $00, $00, $00
    db $00, $00, $00, $00, $00, $06, $07, $83, $E7, $E0, $0F, $01, $80, $00, $00, $00
    db $00, $00, $00, $00, $00, $08, $01, $81, $C5, $C0, $0E, $01, $80, $00, $00, $00
    db $00, $00, $00, $00, $03, $F0, $00, $60, $07, $60, $1C, $00, $80, $00, $00, $00
    db $00, $00, $00, $00, $FC, $10, $00, $30, $0C, $20, $1F, $DD, $80, $00, $00, $00
    db $00, $00, $00, $01, $E0, $14, $03, $F8, $18, $22, $BF, $87, $00, $00, $00, $00
    db $00, $00, $00, $01, $F9, $DD, $06, $1C, $10, $4D, $F0, $07, $00, $00, $00, $00
    db $00, $00, $00, $01, $88, $EF, $C7, $04, $30, $5F, $FC, $0F, $FC, $00, $00, $00
    db $00, $00, $00, $00, $C7, $FF, $A7, $82, $21, $F8, $03, $FE, $02, $00, $00, $00
    db $00, $00, $00, $00, $7C, $07, $E7, $C2, $67, $E0, $00, $FD, $03, $00, $00, $00
    db $00, $00, $00, $00, $30, $0F, $F3, $C2, $5B, $88, $00, $7A, $03, $00, $00, $00
    db $00, $00, $00, $00, $60, $DC, $1F, $61, $7E, $0C, $00, $6E, $06, $00, $00, $00
    db $00, $00, $00, $00, $F9, $EC, $01, $E1, $78, $1C, $1C, $71, $8C, $00, $00, $00
    db $00, $00, $00, $00, $CE, $A7, $00, $F8, $F0, $6C, $78, $81, $98, $00, $00, $00
    db $00, $00, $00, $00, $61, $C0, $FE, $5F, $C0, $D9, $F3, $01, $C0, $00, $00, $00
    db $00, $00, $00, $00, $78, $41, $D3, $7F, $C7, $FF, $FF, $FF, $FC, $00, $00, $00
    db $00, $00, $00, $0F, $8F, $CE, $F8, $1F, $FF, $C0, $3F, $EF, $83, $C0, $00, $00
    db $00, $00, $00, $F8, $00, $CB, $80, $03, $F8, $20, $0F, $F8, $0E, $40, $00, $00
    db $00, $00, $07, $80, $00, $4D, $00, $06, $0C, $20, $0C, $C0, $70, $40, $00, $00
    db $00, $00, $1F, $00, $00, $45, $40, $0C, $18, $25, $0F, $87, $00, $40, $00, $00
    db $00, $00, $10, $F8, $03, $FF, $50, $0C, $18, $6B, $58, $78, $00, $C0, $00, $00
    db $00, $00, $10, $0F, $0E, $01, $BA, $8C, $3F, $FF, $FE, $0C, $01, $C0, $00, $00
    db $00, $00, $10, $00, $F0, $00, $7A, $8C, $6F, $FF, $F8, $06, $00, $40, $00, $00
    db $00, $00, $10, $00, $20, $00, $FF, $FF, $FC, $01, $C0, $02, $00, $C0, $00, $00
    db $00, $00, $18, $00, $20, $01, $80, $00, $00, $1F, $40, $02, $00, $C0, $00, $00
    db $00, $00, $10, $00, $61, $C3, $E0, $00, $01, $E0, $20, $02, $00, $80, $00, $00
    db $00, $00, $18, $00, $42, $23, $3F, $00, $0F, $00, $21, $42, $07, $80, $00, $00
    db $00, $00, $10, $00, $42, $23, $00, $F8, $70, $00, $22, $23, $3B, $00, $00, $00
    db $00, $00, $1E, $00, $41, $E7, $00, $0F, $80, $00, $72, $23, $63, $00, $00, $00
    db $00, $00, $07, $E2, $40, $07, $00, $02, $00, $00, $71, $C3, $02, $00, $00, $00
    db $00, $00, $02, $1F, $40, $07, $00, $02, $00, $00, $70, $02, $02, $00, $00, $00
    db $00, $00, $02, $01, $E0, $07, $00, $02, $00, $00, $20, $02, $06, $00, $00, $00
    db $00, $00, $03, $00, $63, $03, $00, $03, $00, $00, $60, $02, $06, $00, $00, $00
    db $00, $00, $03, $00, $21, $C3, $00, $03, $00, $07, $E0, $02, $06, $00, $00, $00
    db $00, $00, $03, $00, $30, $C3, $80, $01, $00, $3C, $60, $02, $06, $00, $00, $00
    db $00, $00, $02, $00, $30, $01, $BC, $31, $01, $C0, $40, $02, $04, $00, $00, $00
    db $00, $00, $02, $00, $30, $01, $83, $E1, $3E, $00, $40, $02, $04, $00, $00, $00
    db $00, $00, $02, $00, $30, $00, $80, $1F, $E0, $00, $40, $02, $04, $00, $00, $00
    db $00, $00, $02, $00, $30, $00, $C0, $06, $00, $00, $40, $02, $04, $00, $00, $00
    db $00, $00, $02, $00, $30, $00, $C0, $06, $00, $00, $41, $E2, $04, $00, $00, $00
    db $00, $00, $02, $00, $31, $A0, $C0, $07, $00, $00, $42, $22, $04, $00, $00, $00
    db $00, $00, $03, $00, $32, $10, $C0, $02, $00, $00, $62, $12, $04, $00, $00, $00
    db $00, $00, $02, $00, $22, $10, $C0, $03, $00, $00, $62, $22, $00, $00, $00, $00
    db $00, $00, $02, $00, $22, $10, $C0, $03, $00, $00, $61, $C2, $04, $00, $00, $00
    db $00, $00, $06, $00, $21, $E0, $C0, $02, $00, $00, $40, $02, $08, $00, $00, $00
    db $00, $00, $06, $00, $20, $00, $C0, $02, $00, $00, $40, $02, $70, $00, $00, $00
    db $00, $00, $06, $00, $20, $00, $C0, $02, $00, $00, $40, $03, $80, $00, $00, $00
    db $00, $00, $07, $00, $20, $01, $C0, $02, $00, $00, $40, $0B, $00, $00, $00, $00
    db $00, $00, $03, $C0, $20, $01, $C0, $02, $00, $00, $40, $1C, $00, $00, $00, $00
    db $00, $00, $00, $3C, $20, $01, $C0, $03, $00, $00, $40, $70, $00, $00, $00, $00
    db $00, $00, $00, $03, $E0, $01, $C0, $03, $00, $00, $65, $C0, $00, $00, $00, $00
    db $00, $00, $00, $00, $74, $01, $C0, $02, $00, $00, $6F, $00, $00, $00, $00, $00
    db $00, $00, $00, $00, $17, $01, $C0, $02, $00, $01, $F0, $00, $00, $00, $00, $00
    db $00, $00, $00, $00, $0F, $E1, $C0, $03, $00, $0E, $00, $00, $00, $00, $00, $00
    db $00, $00, $00, $00, $00, $7C, $80, $03, $00, $70, $00, $00, $00, $00, $00, $00
    db $00, $00, $00, $00, $00, $03, $F8, $03, $03, $80, $00, $00, $00, $00, $00, $00
    db $00, $00, $00, $00, $00, $00, $47, $03, $0C, $00, $00, $00, $00, $00, $00, $00
    db $00, $00, $00, $00, $00, $00, $00, $F3, $70, $00, $00, $00, $00, $00, $00, $00
    db $00, $00, $00, $00, $00, $00, $00, $1F, $80, $00, $00, $00, $00, $00, $00, $00
    db $00, $00, $00, $00, $00, $00, $00, $00, $00, $00, $00, $00, $00, $00, $00, $00
